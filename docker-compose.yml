version: '3'

services:
  rtorrent:
      image: binhex/arch-rtorrentvpn
      container_name: mediabox-rtorrent
      depends_on:
        - nginx-proxy
        - letsencrypt
      cap_add:
        - NET_ADMIN
      volumes:
        - ${CONFIG_PATH}/rtorrent:/config
        - ${DATA_PATH}/downloads:/data 
        - /etc/localtime:/etc/localtime:ro
      environment:
        - PUID=${PUID}
        - PGID=${PGID}
        - PHP_TZ=${TIME_ZONE}
        - DEBUG=false
        - UMASK=022
        - NAME_SERVERS=209.222.18.222,84.200.69.80,37.235.1.174,1.1.1.1,209.222.18.218,37.235.1.177,84.200.70.40,1.0.0.1
        - LAN_NETWORK=192.168.1.0/24
        - ENABLE_RPC2_AUTH=yes
        - ENABLE_RPC2=yes
        - ENABLE_AUTODL_IRSSI=no
        - ENABLE_PRIVOXY=no
        - STRICT_PORT_FORWARD=${VPN_STRICT_PORT_FORWARD}
        - VPN_PROV=${VPN_PROV}
        - VPN_USER=${VPN_USER}
        - VPN_PASS=${VPN_PASS}
        - VPN_ENABLED=${VPN_ENABLED}
        - VIRTUAL_HOST=download.${DOMAIN}
        - VIRTUAL_PORT=9080
        - LETSENCRYPT_HOST=download.${DOMAIN}
        - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      ports:
        - 9080:9080
        - 9443:9443
        - 8118:8118
      restart: unless-stopped
      privileged: true
      networks:
        - torrent
  
  sonarr:
    image: linuxserver/sonarr
    container_name: mediabox-sonarr
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=sonarr.${DOMAIN}
      - LETSENCRYPT_HOST=sonarr.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=8989
    volumes:
      - ${CONFIG_PATH}/sonarr:/config
      - ${DATA_PATH}/downloads:/downloads
      - ${DATA_PATH}/tv:/tv
    ports:
      - 8989:8989
    restart: unless-stopped
    networks:
      - torrent
  
  radarr:
    image: linuxserver/radarr
    container_name: mediabox-radarr
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=radarr.${DOMAIN}
      - LETSENCRYPT_HOST=radarr.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=7878
    volumes:
      - ${CONFIG_PATH}/radarr:/config
      - ${DATA_PATH}/downloads:/downloads
      - ${DATA_PATH}/movies:/movies
    ports:
      - 7878:7878
    restart: unless-stopped
    networks:
      - torrent
  
  lidarr:
    image: linuxserver/lidarr
    container_name: mediabox-lidarr
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=lidarr.${DOMAIN}
      - LETSENCRYPT_HOST=lidarr.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=8686
    volumes:
      - ${CONFIG_PATH}/lidarr:/config
      - ${DATA_PATH}/downloads:/downloads
      - ${DATA_PATH}/music:/music
    ports:
      - 8686:8686
    restart: unless-stopped
    networks:
      - torrent

  bazarr:
    image: linuxserver/bazarr
    container_name: mediabox-bazarr
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=bazarr.${DOMAIN}
      - LETSENCRYPT_HOST=bazarr.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=6767
    volumes:
      - ${CONFIG_PATH}/bazarr:/config
      - ${DATA_PATH}/movies:/movies
      - ${DATA_PATH}/tv:/tv
    ports:
      - 6767:6767
    restart: unless-stopped
    networks:
      - torrent

  jackett:
    image: linuxserver/jackett
    container_name: mediabox-jackett
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=jackett.${DOMAIN}
      - LETSENCRYPT_HOST=jackett.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=9117
    volumes:
      - ${CONFIG_PATH}/jackett:/config
    ports:
      - 9117:9117
    restart: unless-stopped
    networks:
      - torrent
  
  jellyfin:
    image: linuxserver/jellyfin
    container_name: mediabox-jellyfin
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TIME_ZONE}
      - VIRTUAL_HOST=jellyfin.${DOMAIN}
      - LETSENCRYPT_HOST=jellyfin.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - VIRTUAL_PORT=8096
    volumes:
      - ${CONFIG_PATH}/jellyfin:/config
      - ${DATA_PATH}/tv:/data/tvshows
      - ${DATA_PATH}/movies:/data/movies
      - ${DATA_PATH}/music:/data/music
    ports:
      - 8096:8096
    restart: unless-stopped

  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: mediabox-nginx-proxy
    depends_on:
      - nginx-proxy
      - letsencrypt
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ${CONFIG_PATH}/nginx-proxy/conf.d:/etc/nginx/conf.d
      - ${CONFIG_PATH}/nginx-proxy/vhost.d:/etc/nginx/vhost.d
      - ${CONFIG_PATH}/nginx-proxy/html:/usr/share/nginx/html
      - ${CONFIG_PATH}/nginx-proxy/dhparam:/etc/nginx/dhparam
      - ${CONFIG_PATH}/certs:/etc/nginx/certs:ro
    ports:
      - 80:80
      - 443:443
    restart: unless-stopped
    labels:
      - 'com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy'

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: mediabox-letsencrypt
    depends_on:
      - nginx-proxy
      - letsencrypt
    environment:
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL}
      - NGINX_PROXY_CONTAINER=mediabox-nginx-proxy
      - DEBUG=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONFIG_PATH}/nginx-proxy/conf.d:/etc/nginx/conf.d
      - ${CONFIG_PATH}/nginx-proxy/vhost.d:/etc/nginx/vhost.d
      - ${CONFIG_PATH}/nginx-proxy/html:/usr/share/nginx/html
      - ${CONFIG_PATH}/nginx-proxy/dhparam:/etc/nginx/dhparam
      - ${CONFIG_PATH}/certs:/etc/nginx/certs:rw
    restart: unless-stopped
  
  nextcloud-db:
    image: mariadb
    container_name: mediabox-nextcloud-db
    depends_on:
      - nginx-proxy
      - letsencrypt
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_DB_ROOT_PSW}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=${NEXTCLOUD_DB_USER}
      - MYSQL_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
    restart: unless-stopped

  nextcloud:
    image: nextcloud
    container_name: mediabox-nextcloud
    depends_on:
      - nextcloud-db
      - nginx-proxy
      - letsencrypt
    environment:
      - VIRTUAL_HOST=cloud.${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - LETSENCRYPT_HOST=cloud.${DOMAIN}
      - VIRTUAL_PORT=80
    volumes:
      - ${DATA_PATH}:/data
    ports:
      - 8282:80
    restart: unless-stopped

networks:
  torrent:
    driver: bridge
